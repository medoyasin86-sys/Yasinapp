<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y.Karizma - Tactical Whiteout</title>

    <!-- Fonts & Libs -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --ff-gold: #d4a017; 
            --ff-light-bg: #f4f7f6;
            --ff-card: #ffffff;
            --heroic-red: #d63031;
            --success-green: #27ae60;
            --squad-blue: #0984e3;
            --ammo-pink: #e84393;
            --text-main: #2d3436;
        }

        body {
            font-family: 'Cairo', sans-serif; background: #dfe6e9; margin: 0;
            display: flex; justify-content: center; color: var(--text-main); overflow-x: hidden;
        }
        .battle-container { width: 100%; max-width: 450px; background: var(--ff-light-bg); min-height: 100vh; border: 1px solid #ccc; position: relative; padding-bottom: 40px; box-shadow: 0 0 30px rgba(0,0,0,0.1); }

        /* Header */
        .warrior-header {
            width: 100%; height: 350px; position: relative;
            background: url('https://w0.peakpx.com/wallpaper/406/339/wallpaper-free-fire-warrior-with-gun-thumbnail.jpg') center top/cover no-repeat;
            display: flex; align-items: flex-end; border-bottom: 4px solid var(--ff-gold);
        }
        .warrior-header::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, var(--ff-light-bg) 5%, transparent 80%); }
        .player-info { position: relative; z-index: 5; padding: 20px; width: 100%; }
        .rank-tag { background: var(--heroic-red); color: white; padding: 2px 10px; font-size: 11px; font-weight: 900; border-radius: 3px; box-shadow: 0 4px 10px rgba(214, 48, 49, 0.3); display: inline-flex; align-items: center; gap: 5px; }
        .player-name { font-size: 38px; font-weight: 900; color: #2d3436; margin: 5px 0; display: flex; align-items: center; gap: 10px; text-shadow: 1px 1px 0px white; }

        /* Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§: Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ù‡Ù… Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
        .commander-orders {
            background: #fff9e6; border: 2px solid var(--ff-gold); margin: 15px; padding: 15px;
            font-size: 12px; border-radius: 8px; color: #444; line-height: 1.7; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%{border-color:var(--ff-gold);} 50%{border-color:#eee;} 100%{border-color:var(--ff-gold);} }

        /* Ù…Ø±Ø¨Ø¹ ÙØªØ±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© */
        .penalty-box {
            background: #fff; border: 2px dashed #f1b6b6; margin: 0 15px 15px 15px; padding: 12px;
            border-radius: 10px; color: #7a3b3b; box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }
        .penalty-title { font-weight: 900; color: var(--heroic-red); display:inline-flex; align-items:center; gap:6px; }
        .penalty-dates { font-weight: 900; color: #b84a4a; }
        .penalty-hint { font-size: 12px; color: #8a6b6b; font-weight: 700; }

        .loot-card { background: var(--ff-card); margin: 0 15px 15px 15px; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .bounty-amount { font-size: 40px; font-weight: 900; color: var(--ff-gold); display: block; }

        /* Date Controller */
        .date-shifter { display: flex; justify-content: space-between; align-items: center; background: #fff; margin: 0 15px 15px 15px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
        .shift-btn { background: #f0f0f0; border: 1px solid #ddd; color: var(--ff-gold); width: 40px; height: 40px; border-radius: 5px; cursor: pointer; font-size: 18px; }
        .date-display { flex: 1; text-align: center; font-weight: 900; cursor: pointer; color: #2d3436; }

        /* Actions */
        .battle-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 15px 20px 15px; }
        .action-btn { padding: 15px; border: none; font-family: 'Cairo'; font-weight: 900; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: transform 0.2s; }
        .action-btn:active { transform: scale(0.95); }
        .btn-booyah { background: var(--ff-gold); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn-defeat { background: #f0f0f0; color: #b2bec3; border: 1px solid #ddd; }

        /* Squad Radio (Chat) */
        .squad-radio-container { background: #fff; margin: 0 15px 20px 15px; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .radio-header { background: #f8f9fa; padding: 8px 12px; font-size: 10px; font-weight: 900; color: var(--squad-blue); border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 5px; }
        .chat-box { height: 180px; overflow-y: auto; padding: 10px; background: #fff; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 12px; line-height: 1.4; padding: 6px 10px; border-radius: 6px; background: #f1f2f6; border-right: 3px solid transparent; color: #2d3436; }
        .msg-papa { border-right-color: var(--ff-gold); background: #fffdf2; }
        .msg-mama { border-right-color: var(--ammo-pink); background: #fdf2f7; }
        .msg-yassin { border-right-color: var(--squad-blue); background: #f2f7ff; }
        .role-tag { font-weight: 900; font-size: 9px; margin-left: 5px; padding: 1px 5px; border-radius: 3px; }
        .tag-papa { background: var(--ff-gold); color: #fff; }
        .tag-mama { background: var(--ammo-pink); color: #fff; }
        .tag-yassin { background: var(--squad-blue); color: #fff; }

        .chat-input-area { display: flex; background: #f8f9fa; padding: 8px; gap: 5px; border-top: 1px solid #eee; }
        .sender-select, .toolbar-select { background: #fff; border: 1px solid #ddd; font-size: 10px; border-radius: 4px; padding: 0 5px; }
        .msg-input { flex: 1; border: 1px solid #ddd; padding: 8px; font-size: 12px; border-radius: 4px; outline: none; }
        .btn-send { background: var(--ff-gold); border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; color: white; }
        .btn-export { background: var(--ff-gold); border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; color: #fff; font-weight: 900; }

        /* History (Calendar) */
        .battle-log { background: #fff; margin: 0 15px; border-radius: 10px; border: 1px solid #ddd; }
        .log-header { padding: 10px; font-size: 12px; color: var(--ff-gold); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; align-items: center; gap: 8px; }
        .log-tools { display:flex; gap:6px; align-items:center; flex-wrap: wrap; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 10px; }
        .cal-head { text-align: center; font-weight: 900; font-size: 11px; color: #777; }
        .cal-cell {
            background: #fff; border: 1px solid #eee; border-radius: 8px; min-height: 64px; padding: 6px;
            display: flex; flex-direction: column; gap: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .cal-cell.empty { background: #fafafa; border-style: dashed; opacity: 0.6; }
        .cal-date { font-weight: 900; font-size: 12px; color: #2d3436; }
        .cal-status { font-size: 11px; }
        .cal-status.dry { color: var(--success-green); font-weight: 900; }
        .cal-status.wet { color: var(--heroic-red); font-weight: 900; }
        .cal-cell.active { outline: 2px solid var(--ff-gold); }
        .cal-cell.muted { opacity: .35; }

        input[type="date"] { display: none; }
    </style>
</head>
<body>

<div class="battle-container">
    <div class="warrior-header">
        <div class="player-info">
            <span class="rank-tag">ğŸ† GRANDMASTER ğŸ–ï¸</span>
            <h1 class="player-name">ğŸ¥· Y.KARIZMA ğŸ”«</h1>
        </div>
    </div>

    <!-- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙŠØ§: Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ù‡Ù… Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ -->
    <div class="commander-orders" id="commander-orders">
        ğŸ“¢ <b>ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…:</b><br>
        ØªÙ…Øª Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙØ±ØµØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ ÙˆÙ„ÙƒÙ† ØªÙ‚Ù„Ù‘ØµØª Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù„ØªØµØ¨Ø­ <b>Ù¥Ù Ù  Ø¬Ù†ÙŠÙ‡</b> ÙÙ‚Ø·ØŒ
        ÙˆØ³ÙŠØªÙ… ÙˆØ¶Ø¹Ùƒ ÙÙŠ <b>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ØªØ­Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</b>ØŒ Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù… (<b>Ø£Ø¨Ø±ÙŠÙ„</b>).
    </div>

    <!-- Ù…Ø±Ø¨Ø¹ ÙØªØ±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© (ØªØ­ÙÙŠØ²ÙŠ) -->
    <div class="penalty-box">
        <div class="penalty-title">â›” ÙØªØ±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§:</div>
        <div class="penalty-dates">Ù…Ù† <b>Ù¢Ù  ÙØ¨Ø±Ø§ÙŠØ±</b> Ø¥Ù„Ù‰ <b>Ù¢ Ù…Ø§Ø±Ø³</b></div>
        <div class="penalty-hint">Ù„Ø§ ØªØ¶Ø¹ Ù†ÙØ³Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ â€” Ø£Ø«Ø¨Øª Ù„Ù†ÙØ³Ùƒ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ù„Ù„ÙƒØªÙŠØ¨Ø© Ø£Ù†Ùƒ Ø¹Ù„Ù‰ Ù‚Ø¯Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©. ğŸ’ª</div>
    </div>

    <div class="loot-card">
        <span style="font-size: 11px; color: #888; font-weight: bold;">ğŸ’ STRATEGIC BOUNTY</span>
        <span class="bounty-amount" id="money">1000</span>
    </div>

    <div class="date-shifter">
        <button class="shift-btn" onclick="changeDay(-1)">â—€ï¸</button>
        <div class="date-display" onclick="document.getElementById('date-input').showPicker()">
            <div id="date-text">ğŸ“… ØªØ­Ù…ÙŠÙ„...</div>
            <div id="status-text" style="font-size:10px; color: #999;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ØµØ¯</div>
        </div>
        <button class="shift-btn" onclick="changeDay(1)">â–¶ï¸</button>
        <input type="date" id="date-input" onchange="setDate(this.value)">
    </div>

    <div class="battle-actions">
        <button class="action-btn btn-booyah" id="win-btn" onclick="register(true)">BOOYAH!</button>
        <button class="action-btn btn-defeat" id="loss-btn" onclick="register(false)">DEFEAT</button>
    </div>

    <div class="squad-radio-container">
        <div class="radio-header">ğŸ“¡ SQUAD RADIO - Ø±Ø§Ø¯ÙŠÙˆ Ø§Ù„ÙƒØªÙŠØ¨Ø©</div>
        <div class="chat-box" id="chat-messages"></div>
        <div class="chat-input-area">
            <select id="sender-name" class="sender-select">
                <option value="Ø¨Ø§Ø¨Ø§">Ø¨Ø§Ø¨Ø§ (Commander)</option>
                <option value="Ù…Ø§Ù…Ø§">Ù…Ø§Ù…Ø§ (Supply)</option>
                <option value="ÙŠØ§Ø³ÙŠÙ†">Ø³Ù…Ø³Ù… (Veteran)</option>
            </select>
            <input type="text" id="msg-input" class="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªÙƒØªÙŠÙƒÙŠØ©...">
            <button class="btn-send" onclick="sendMsg()">ğŸ“¡</button>
        </div>
    </div>

    <div class="battle-log">
        <div class="log-header">
            <span>ğŸ“œ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
            <div class="log-tools">
                <label for="calendar-filter" style="font-size:10px;color:#777">ØªØµÙÙŠØ©:</label>
                <select id="calendar-filter" class="toolbar-select" title="ØªØµÙÙŠØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…">
                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                    <option value="dry">Ø¬ÙØ§Ù</option>
                    <option value="wet">Ø¨Ù„Ù„</option>
                </select>

                <label for="export-scope" style="font-size:10px;color:#777">ØªØµØ¯ÙŠØ±:</label>
                <select id="export-scope" class="toolbar-select" title="Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØµØ¯ÙŠØ±">
                    <option value="month">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</option>
                </select>
                <button class="btn-export" onclick="exportCSV()">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>

                <!-- Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ -->
                <button class="btn-export" onclick="exportMonthlyReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>

                <span id="month-stat">0/0</span>
            </div>
        </div>
        <!-- ØªÙ‚ÙˆÙŠÙ… Ø´Ù‡Ø±ÙŠ -->
        <div class="calendar" id="calendar"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAPhrEzYnHoL3ln8_5BFFyWCjx2Y-G80E0",
        authDomain: "yassinapp-20262.firebaseapp.com",
        databaseURL: "https://yassinapp-20262-default-rtdb.firebaseio.com",
        projectId: "yassinapp-20262",
        storageBucket: "yassinapp-20262.firebasestorage.app",
        messagingSenderId: "940031861888",
        appId: "1:940031861888:web:9b7600cbf80b6343"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let historyData = {};
    let activeDate = new Date();
    let currentFilter = 'all'; // all | dry | wet

    function sendMsg() {
        const sender = document.getElementById('sender-name').value;
        const text = document.getElementById('msg-input').value;
        if(!text) return;
        db.ref('squad_chat').push({ sender: sender, text: text, timestamp: Date.now() });
        document.getElementById('msg-input').value = '';
    }

    db.ref('squad_chat').limitToLast(15).on('value', (snap) => {
        const box = document.getElementById('chat-messages');
        box.innerHTML = '';
        snap.forEach(child => {
            const m = child.val();
            let roleClass = m.sender === 'Ø¨Ø§Ø¨Ø§' ? 'msg-papa' : (m.sender === 'Ù…Ø§Ù…Ø§' ? 'msg-mama' : 'msg-yassin');
            let tagClass = m.sender === 'Ø¨Ø§Ø¨Ø§' ? 'tag-papa' : (m.sender === 'Ù…Ø§Ù…Ø§' ? 'tag-mama' : 'tag-yassin');
            box.innerHTML += `<div class="msg ${roleClass}"><span class="role-tag ${tagClass}">${m.sender}</span> ${m.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    function updateDisplay() {
        const key = activeDate.toISOString().split('T')[0];
        const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('date-text').innerText = "ğŸ“… " + activeDate.toLocaleDateString('ar-EG', dateOptions);

        const winBtn = document.getElementById('win-btn'), lossBtn = document.getElementById('loss-btn'), statusText = document.getElementById('status-text');
        if (historyData[key]) {
            winBtn.disabled = lossBtn.disabled = true;
            winBtn.style.opacity = lossBtn.style.opacity = "0.3";
            statusText.innerText = historyData[key] === 'dry' ? "âœ… ØªÙ… Ø§Ù„Ø±ØµØ¯: BOOYAH" : "âŒ ØªÙ… Ø§Ù„Ø±ØµØ¯: DEFEAT";
        } else {
            winBtn.disabled = lossBtn.disabled = false;
            winBtn.style.opacity = lossBtn.style.opacity = "1";
            statusText.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±ØµØ¯ Ø§Ù„Ù…Ù‡Ù…Ø©...";
        }
    }

    function changeDay(delta) {
        activeDate.setDate(activeDate.getDate() + delta);
        calculateBounty(); renderCalendar(); updateDisplay();
    }
    function setDate(val) {
        activeDate = new Date(val);
        calculateBounty(); renderCalendar(); updateDisplay();
    }

    db.ref('yassin_money_quest/history').on('value', (snap) => {
        historyData = snap.val() || {};
        calculateBounty(); renderCalendar(); updateDisplay();
    });

    /* Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙƒÙ…Ø§ ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ */
    function calculateBounty() {
        let dry = 0, wet = 0, hasWet = false;
        Object.entries(historyData).forEach(([date, stat]) => {
            const d = new Date(date);
            if(d.getMonth() === activeDate.getMonth() && d.getFullYear() === activeDate.getFullYear()){
                if(stat === 'dry') dry++; else { wet++; hasWet = true; }
            }
        });

        const y = activeDate.getFullYear();
        theMonth = activeDate.getMonth(); // 0=ÙŠÙ†Ø§ÙŠØ± ... 2=Ù…Ø§Ø±Ø³ ... 3=Ø£Ø¨Ø±ÙŠÙ„
        const m = theMonth;
        const isJan26 = (y === 2026 && m === 0);
        let bounty = 0;

        if (isJan26) {
            bounty = 1000; // Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙŠÙ†Ø§ÙŠØ± 2026
        } else if (y === 2026 && m === 2) {
            bounty = 0;    // Ù…Ø§Ø±Ø³ 2026: Ø´Ù‡Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù„Ø§ Ù…ÙƒØ§ÙØ£Ø©
        } else if (y > 2026 || (y === 2026 && m >= 3)) {
            bounty = hasWet ? (dry * 10) : 500; // Ù…Ù† Ø£Ø¨Ø±ÙŠÙ„ 2026: Ø³Ù‚Ù 500
        } else {
            bounty = hasWet ? (dry * 10) : 1000; // Ù…Ø§ Ù‚Ø¨Ù„ Ø°Ù„Ùƒ: ÙƒÙ…Ø§ ÙƒØ§Ù† (Ø³Ù‚Ù 1000)
        }

        document.getElementById('money').innerText = String(bounty);
        document.getElementById('month-stat').innerText = `âœ… ${dry} | âŒ ${wet}`;
    }

    /* ØªÙ‚ÙˆÙŠÙ… Ø´Ù‡Ø±ÙŠ Ù…Ø¹ ØªØµÙÙŠØ© (Ø§Ù„ÙƒÙ„/Ø¬ÙØ§Ù/Ø¨Ù„Ù„) */
    function renderCalendar() {
        const cal = document.getElementById('calendar');
        if(!cal) return;
        cal.innerHTML = '';

        // Ø±Ø¤ÙˆØ³ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø³Ø¨Øª â†’ Ø§Ù„Ø¬Ù…Ø¹Ø©)
        const heads = ['Ø³', 'Ø­', 'Ù†', 'Ø«', 'Ø±', 'Ø®', 'Ø¬'];
        heads.forEach(h => cal.innerHTML += `<div class="cal-head">${h}</div>`);

        const y = activeDate.getFullYear();
        const m = activeDate.getMonth();
        const firstDay = new Date(y, m, 1);
        const lastDayNum = new Date(y, m + 1, 0).getDate();

        // ÙÙ‡Ø±Ø³ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: Ø¬Ø¹Ù„ Ø§Ù„Ø³Ø¨Øª Ø¹Ù…ÙˆØ¯ 0
        const indexFromSatFirst = (jsDay) => (jsDay + 1) % 7; // Sat(6)->0, Sun(0)->1, Mon(1)->2, ...
        const padding = indexFromSatFirst(firstDay.getDay());

        // Ø®Ù„Ø§ÙŠØ§ ÙØ§Ø±ØºØ© Ù‚Ø¨Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„
        for(let i=0;i<padding;i++){
            cal.innerHTML += `<div class="cal-cell empty"></div>`;
        }

        // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
        const pad2 = n => String(n).padStart(2,'0');
        const keyOf = (yy, mm, dd) => `${yy}-${pad2(mm+1)}-${pad2(dd)}`;

        // Ø±Ø³Ù… Ø§Ù„Ø£ÙŠØ§Ù…
        for(let d=1; d<=lastDayNum; d++){
            const dateObj = new Date(y, m, d);
            const key = keyOf(y, m, d);
            const stat = historyData[key]; // 'dry' | 'wet' | undefined

            let statusHtml = '';
            let statClass = '';
            if (stat === 'dry')  { statusHtml = `Ø¬ÙØ§Ù`; statClass = 'dry'; }
            else if (stat === 'wet') { statusHtml = `Ø¨Ù„Ù„`; statClass = 'wet'; }
            else { statusHtml = `â€”`; statClass = ''; }

            const isActive = (dateObj.toDateString() === activeDate.toDateString());

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ø´ÙŠØ­: ØªØ®ÙÙŠÙ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
            let muted = false;
            if (currentFilter === 'dry' && stat !== 'dry') muted = true;
            if (currentFilter === 'wet' && stat !== 'wet') muted = true;

            cal.innerHTML += `
                <div class="cal-cell ${isActive ? 'active' : ''} ${muted ? 'muted' : ''}">
                    <div class="cal-date">${d}</div>
                    <span class="cal-status ${statClass}">${statusHtml}</span>
                </div>
            `;
        }
    }

    /* ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ CSV (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ/ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„) */
    function exportCSV(){
        const scope = document.getElementById('export-scope')?.value || 'month';
        const rows = [];
        const header = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø­Ø§Ù„Ø©']; // Arabic headers

        const pushRow = (dateStr, stat) => {
            const ar = stat === 'dry' ? 'Ø¬ÙØ§Ù' : (stat === 'wet' ? 'Ø¨Ù„Ù„' : '-');
            rows.push([dateStr, ar]);
        };

        if(scope === 'all'){
            const keys = Object.keys(historyData || {}).sort();
            keys.forEach(k => pushRow(k, historyData[k]));
        } else {
            const y = activeDate.getFullYear();
            const m = activeDate.getMonth();
            Object.entries(historyData).forEach(([date, stat]) => {
                const d = new Date(date);
                if(d.getFullYear() === y && d.getMonth() === m){
                    pushRow(date, stat);
                }
            });
            // ØªØ±ØªÙŠØ¨ Ø´Ù‡Ø±ÙŠ
            rows.sort((a,b)=> a[0].localeCompare(b[0]));
        }

        const csvLines = [header.join(','), ...rows.map(r=> r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))];
        const csvContent = '\uFEFF' + csvLines.join('\n'); // BOM Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Excel
        const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);

        const y = activeDate.getFullYear();
        const m = String(activeDate.getMonth()+1).padStart(2,'0');
        const filename = scope === 'all' ? `history_all.csv` : `history_${y}-${m}.csv`;

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    /* Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ (Print -> PDF) */
    function exportMonthlyReport(){
        const y = activeDate.getFullYear();
        const m = activeDate.getMonth(); // 0..11
        const localeMonth = activeDate.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });

        let dry = 0, wet = 0, hasWet = false;
        const days = [];
        const lastDayNum = new Date(y, m + 1, 0).getDate();
        const pad2 = n => String(n).padStart(2, '0');

        for(let d=1; d<=lastDayNum; d++){
            const key = `${y}-${pad2(m+1)}-${pad2(d)}`;
            const stat = historyData[key] || null; // 'dry'|'wet'|null
            if (stat === 'dry') dry++;
            if (stat === 'wet') { wet++; hasWet = true; }
            days.push({ date: key, stat });
        }

        // Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø¨Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const isJan26 = (y === 2026 && m === 0);
        let bounty = 0;
        if (isJan26) bounty = 1000;
        else if (y === 2026 && m === 2) bounty = 0;
        else if (y > 2026 || (y === 2026 && m >= 3)) bounty = hasWet ? (dry * 10) : 500;
        else bounty = hasWet ? (dry * 10) : 1000;

        const adherence = (dry + wet) > 0 ? Math.round((dry / (dry + wet)) * 100) : 0;

        const reportHTML = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ â€” ${localeMonth}</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#1a4d2e; --gold:#d4a017; --muted:#7a6b4e; --danger:#b33a3a; --ok:#27ae60; --border:#eadfbe; }
  body{ font-family:'Cairo',sans-serif; margin:18px; color:#2d3436; background:#fff; }
  .hdr{ border:2px solid var(--gold); border-radius:12px; padding:12px 14px; margin-bottom:14px; background:linear-gradient(135deg,#fff9e6,#fff); }
  .title{ font-weight:900; margin:0 0 6px 0; color:#634e1e; }
  .tags{ display:flex; gap:10px; flex-wrap:wrap; color:#7a6b4e; font-weight:700; }
  .tag{ background:#fff7d6; border:1px solid var(--gold); border-radius:999px; padding:2px 8px; }
  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:10px; }
  .card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
  .kpis{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .kpi{ background:#faf7ea; border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center; }
  .kpi .k{ display:block; color:#7a6b4e; font-size:.9rem; }
  .kpi .v{ display:block; font-weight:900; font-size:1.05rem; }
  .table{ width:100%; border-collapse:collapse; margin-top:8px; }
  .table th, .table td{ border:1px solid #eee5c8; padding:6px 8px; font-size:.95rem; }
  .table th{ background:#fff9e6; color:#634e1e; }
  .status{ font-weight:900; }
  .dry{ color:var(--ok); } .wet{ color:var(--danger); } .none{ color:#999; }
  .note{ font-size:.9rem; color:#7a6b4e; margin-top:8px; }
  @media print{ body{ margin:12mm; } }
</style>
</head>
<body>
  <header class="hdr">
    <h2 class="title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
    <div class="tags">
      <span class="tag">Ø§Ù„Ø´Ù‡Ø±: ${localeMonth}</span>
      <span class="tag">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${new Date().toLocaleString('ar-EG')}</span>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <h3 style="margin:0 0 6px 0; color:#0f3b22;">Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h3>
      <div class="kpis">
        <div class="kpi"><span class="k">Ø¬ÙØ§Ù</span><span class="v">${dry}</span></div>
        <div class="kpi"><span class="k">Ø¨Ù„Ù„</span><span class="v">${wet}</span></div>
        <div class="kpi"><span class="k">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬ÙØ§Ù</span><span class="v">${adherence}%</span></div>
        <div class="kpi"><span class="k">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</span><span class="v">${bounty} Ø¬</span></div>
      </div>
      <div class="note">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ØªÙØ­ØªØ³Ø¨ ÙˆÙÙ‚ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px 0; color:#0f3b22;">ÙØªØ±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©</h3>
      <div class="note">â›” Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§: <b>Ù¢Ù  ÙØ¨Ø±Ø§ÙŠØ±</b> â†’ <b>Ù¢ Ù…Ø§Ø±Ø³</b></div>
      <div class="note">Ù„Ø§ ØªØ¶Ø¹ Ù†ÙØ³Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ â€” ÙƒÙ† Ø¹Ù„Ù‰ Ù‚Ø¯Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©. ğŸ’ª</div>
    </div>
  </section>

  <section class="card" style="margin-top:10px;">
    <h3 style="margin:0 0 6px 0; color:#0f3b22;">Ø³Ø¬Ù„ Ø§Ù„Ø£ÙŠØ§Ù…</h3>
    <table class="table">
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
      <tbody>
        ${days.map(d=>{
          const label = d.stat==='dry' ? 'Ø¬ÙØ§Ù' : (d.stat==='wet' ? 'Ø¨Ù„Ù„' : 'â€”');
          const cls   = d.stat==='dry' ? 'dry' : (d.stat==='wet' ? 'wet' : 'none');
          return `<tr><td>${d.date}</td><td class="status ${cls}">${label}</td></tr>`;
        }).join('')}
      </tbody>
    </table>
  </section>
  <script>setTimeout(()=>{ try{ window.print(); }catch(e){} }, 300);</script>
</body>
</html>
        `;

        const w = window.open('', '_blank');
        if(!w){ alert('ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.'); return; }
        w.document.open();
        w.document.write(reportHTML);
        w.document.close();
    }

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ø§Ù„ØªØµÙÙŠØ©)
    document.addEventListener('DOMContentLoaded', () => {
        const filterSel = document.getElementById('calendar-filter');
        if(filterSel){
            filterSel.onchange = () => { currentFilter = filterSel.value || 'all'; renderCalendar(); };
        }
    });

    function register(isDry) {
        const key = activeDate.toISOString().split('T')[0];
        if(historyData[key]) return;
        if(isDry) confetti({ particleCount: 100, spread: 70 });
        db.ref('yassin_money_quest/history').update({ [key]: isDry ? 'dry' : 'wet' });
    }

    document.getElementById('date-input').valueAsDate = new Date();
    calculateBounty();
    renderCalendar();
    updateDisplay();
</script>
</body>
</html>
